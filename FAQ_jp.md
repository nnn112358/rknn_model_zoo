- [1. 一般的な問題](#1-一般的な問題)
  - [1.1 RKNPUの関連依存ライブラリをアップグレードする方法](#11-rknpuの関連依存ライブラリをアップグレードする方法)
  - [1.2 プラットフォームによって結果が異なる](#12-プラットフォームによって結果が異なる)
  - [1.3 デモの結果が正しくない](#13-デモの結果が正しくない)
  - [1.4 デモは正しく実行されたが、自分のモデルに置き換えると間違って実行された](#14-デモは正しく実行されたが自分のモデルに置き換えると間違って実行された)
  - [1.5 モデル推論性能がリファレンス性能を満たさない](#15-モデル推論性能がリファレンス性能を満たさない)
  - [1.6 モデル量子化後の精度問題を解決する方法](#16-モデル量子化後の精度問題を解決する方法)
  - [1.7 ボード側Pythonデモはありますか](#17-ボード側pythonデモはありますか)
  - [1.8 他のモデルのデモがないのはなぜですか？サポートされていないからですか](#18-他のモデルのデモがないのはなぜですかサポートされていないからですか)
  - [1.9 LLMモデルのデモはありますか？](#19-llmモデルのデモはありますか)
  - [1.10 RV1103とRV1106で実行できるデモが少ない理由](#110-rv1103とrv1106で実行できるデモが少ない理由)
  - [1.11 OpenCVとJPEGライブラリを一緒に使用するとセグメンテーションフォールトエラーが発生する](#111-opencvとjpegライブラリを一緒に使用するとセグメンテーションフォールトエラーが発生する)
  - [1.12 コンパイル中に失敗したり、実行時に一部の依存ライブラリが見つからないというプロンプトが表示される](#112-コンパイル中に失敗したり実行時に一部の依存ライブラリが見つからないというプロンプトが表示される)
- [2. RGA](#2-rga)
- [3. YOLO](#3-yolo)
  - [3.1 クラスの信頼度が1を超える](#31-クラスの信頼度が1を超える)
  - [3.2 推論結果に非常に多くのボックスがあり、画像全体を埋める](#32-推論結果に非常に多くのボックスがあり画像全体を埋める)
  - [3.3 ボックスの位置と信頼度は正しいが、サイズがうまく一致しない（yolov5、yolov7）](#33-ボックスの位置と信頼度は正しいがサイズがうまく一致しない（yolov5yolov7）)
  - [3.4 MAP精度が公式結果より低い](#34-map精度が公式結果より低い)
  - [3.5 モデル構造を変更せずにNPUでYOLOを実行できますか？](#35-モデル構造を変更せずにnpuでyoloを実行できますか)

## 1. 一般的な問題

### 1.1 RKNPUの関連依存ライブラリをアップグレードする方法

|              | RKNPU1                                                       | RKNPU2                                                       |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| プラットフォーム | RV1109<br />RV1126<br />RK1808<br />RK3399pro                | RV1103<br />RV1106<br />RK3562<br />RK3566<br />RK3568<br />RK3588<br />RK3576 |
| ドライバ       | .koファイルを置き換えてアップグレード                            | 新しいファームウェアを焼き込んでアップグレード                  |
| ランタイム      | [ドキュメント](https://github.com/airockchip/rknpu/blob/master/README.md)を参照し、**librknn_runtime.so**とその関連する依存ファイルを置き換えてアップグレードします。<br /><br />（PC-ボードデバッグ機能を使用するには、ドキュメントに記載されている**rknn_server**ファイルを更新する必要があります） | [ドキュメント](https://github.com/airockchip/rknn-toolkit2/blob/master/doc/rknn_server_proxy.md)を参照し、**librknnrt.so**ファイルを置き換えてアップグレードします<br />（RV1103/RV1106はランタイムの縮小版を使用し、対応するファイル名は**librknnmrt.so**です）<br /><br />（PC-ボードデバッグ機能を使用するには、ドキュメントに記載されている**rknn_server**ファイルを更新する必要があります） |
| RKNN-Toolkit | [ドキュメント](https://github.com/airockchip/rknn-toolkit/blob/master/README.md)を参照して、新しいpython whlファイルをインストールしてアップグレードします | [ドキュメント](https://github.com/airockchip/rknn-toolkit2/blob/master/doc/02_Rockchip_RKNPU_User_Guide_RKNN_SDK_V2.2.0_EN.pdf)の**第2.1章**を参照して、新しいpython whlファイルをインストールしてアップグレードします |

- 開発ボードの仕様の違いにより、ファームウェアは通常互いに互換性がありません。新しいファームウェアと焼き込み方法を入手するには、購入元にお問い合わせください。

### 1.2 プラットフォームによって結果が異なる

NPU世代の影響を受け、推論結果が少し異なるのは正常です。差が大きい場合は、問題としてフィードバックしてください。

### 1.3 デモの結果が正しくない

**ドライバ**、runtime.so、および**RKNN-Toolkit**のバージョンが[ドキュメント](README.md)に記載されているバージョン要件を満たしているかどうかを確認してください。

### 1.4 デモは正しく実行されたが、自分のモデルに置き換えると間違って実行された

モデルをエクスポートする際にデモドキュメントの要件に従っているかどうかを確認してください。例えば、[ドキュメント](./examples/yolov5/README.md)に従い、https://github.com/airockchip/yolov5 を使用してonnxモデルをエクスポートします。

### 1.5 モデル推論性能がリファレンス性能を満たさない

以下の要因が推論性能の差を引き起こす可能性があります：

- **python api**の推論性能は弱い場合があるため、**C api**に基づいて推論性能をテストしてください。

- rknn model zooの推論性能データには**前処理と後処理が含まれていません**。完全なデモの時間消費とは異なり、**rknn.run**の時間消費のみをカウントしています。これらの他の操作の時間消費は、使用シナリオとシステムリソースの占有に関連しています。
- ボードが[scaling_frequency.sh](./scaling_frequency.sh)で設定された最大周波数に**固定周波数に到達**しているかどうか。一部のファームウェアは、CPU/NPU/DDRの最大周波数を制限し、推論性能を低下させる可能性があります。
- **CPU/NPUと帯域幅リソース**を占有する他のアプリケーションがあるかどうか。これは推論性能を低下させます。
- 大小コアCPUを持つチップ（現在RK3588、RK3576）の場合、[ドキュメント](https://github.com/airockchip/rknn-toolkit2/blob/master/doc/02_Rockchip_RKNPU_User_Guide_RKNN_SDK_V2.2.0_EN.pdf)の第5.3.3章を参照し、**テスト用に大きなCPUコアをバインド**してください。

### 1.6 モデル量子化後の精度問題を解決する方法

量子化機能が正しく使用されているかどうかを確認するために、[ユーザーガイドドキュメント](https://github.com/airockchip/rknn-toolkit2/blob/master/doc/02_Rockchip_RKNPU_User_Guide_RKNN_SDK_V2.2.0_EN.pdf)を参照してください。

**モデル構造**特性と**重み分布**がint8量子化の精度損失を引き起こす場合は、**ハイブリッド量子化**または**QAT量子化**の使用を検討してください。

### 1.7 ボード側Pythonデモはありますか

ボード側に**RKNN-Toolkit-lite**をインストールし、デモに対応するpython推論スクリプトを使用して、ボード上でのpython推論を実装します。RKNPU1デバイスの場合は、[RKNN-Toolkit-lite](https://github.com/airockchip/rknn-toolkit/tree/master/rknn-toolkit-lite)を参照してください。RKNPU2デバイスの場合は、[RKNN-Toolkit-lite2](https://github.com/airockchip/rknn-toolkit2/tree/master/rknn-toolkit-lite2)を参照してください。

（一部の例には現在pythonデモがありません。また、パフォーマンスを重視するユーザーには、デプロイにはCインターフェースを使用することをお勧めします）

### 1.8 他のモデルのデモがないのはなぜですか？サポートされていないからですか

実際にはほとんどのモデルがサポートされています。開発期間の制限と、ほとんどの開発者のニーズを考慮して、実用性の高いモデルをデモ例として選択しました。より良いモデルの推薦がある場合は、問題を提出するか、お問い合わせください。

### 1.9 LLMモデルのデモはありますか？

現在は提供されていません。transformerモデルのサポートはまだ徐々に最適化されており、開発者が参照・使用できる大型モデルデモをできるだけ早く提供したいと考えています。

### 1.10 RV1103とRV1106で実行できるデモが少ない理由

**RV1103**と**RV1106**の**メモリ**サイズ制限により、多くの大きなモデルのメモリ使用量がボードの制限を超えるため、現在対応するデモは提供されていません。

### 1.11 OpenCVとJPEGライブラリを一緒に使用するとセグメンテーションフォールトエラーが発生する

これは、OpenCVに含まれるJPEGライブラリがrknn_model_zoo/3rdpartyのjpeg_turboライブラリと競合するためです。解決策は以下の通りです：
1. JPEGライブラリなしでOpenCVライブラリを再コンパイルする
2. OpenCVを使用してJPG画像の読み取りまたは保存のみを行う場合は、./build-linux.shまたは./build-android.shで'-j'パラメータを指定してjpeg_turboライブラリを無効にすることができます

### 1.12 コンパイル中に失敗したり、実行時に一部の依存ライブラリが見つからないというプロンプトが表示される

これは、現在使用しているクロスコンパイラがrknn_model_zooで使用されるデフォルトのクロスコンパイラと異なるためです。[Compilation_Environment_Setup_Guide.md](./docs/Compilation_Environment_Setup_Guide.md)ドキュメントの指示に従って、対応するコンパイラを使用して再コンパイルしてください（注意：古いビルドディレクトリを削除することを忘れないでください）

## 2. RGA

RGA関連の問題については、[RGAドキュメント](https://github.com/airockchip/librga/blob/main/docs/Rockchip_FAQ_RGA_EN.md)を参照してください。

## 3. YOLO

### 3.1 クラスの信頼度が1を超える

YOLOの**後処理コード**はモデル構造と一致している必要があります。そうでなければ例外が発生します。現在のYOLOデモで使用されている後処理では、モデルの**カテゴリ信頼度出力**が**sigmoid操作によって生成**される必要があります。sigmoid操作は、(-∞, ∞)の信頼度を(0, 1)の信頼度に調整します。このsigmoid操作の欠如により、カテゴリ信頼度が1より大きくなる原因となります。以下に示す通りです：

![yolov5_without_sigmoid_out](asset/yolov5_without_sigmoid_out.png)

このような問題に遭遇した場合は、デモドキュメントの指示を参照してモデルをエクスポートしてください。

### 3.2 推論結果に非常に多くのボックスがあり、画像全体を埋める

![yolo_too_much_box](asset/yolo_too_much_box.png)

上記のように、2つの可能性があります：

- 3.1節と同じく、モデルの末尾でsigmoid操作が欠如していることがこの問題を引き起こす可能性があります。
- デモで**ボックスのしきい値**が小さすぎる、または**NMSのしきい値**が大きすぎる。

### 3.3 ボックスの位置と信頼度は正しいが、サイズがうまく一致しない（yolov5、yolov7）

この問題は通常、**アンカーの不一致**によって引き起こされます。モデルをエクスポートする際は、表示されるアンカー情報がデモのデフォルトアンカー設定と一致しないかどうかに注意してください。

### 3.4 MAP精度が公式結果より低い

主に2つの理由があります：

- 公式mapテストは**動的形状モデル**を使用しますが、rknn model zooは簡単さと使いやすさのために**固定形状モデル**を使用しており、mapテスト結果は動的形状モデルよりも低くなります。
- RKNNモデルは**量子化**が有効になった後、精度の損失も発生します。

- ユーザーがボード上でmapの結果をテストするためにCインターフェースを使用しようとする場合、画像の読み取り方法がテスト結果に影響することに注意してください。例えば、**cv2**と**stbi**に基づいてテストする場合、map結果は異なります。

### 3.5 モデル構造を変更せずにNPUでYOLOを実行できますか？

**はい、できますが、推奨されません。**

モデル構造が変更された場合、pythonデモとCデモに対応する後処理コードを調整する必要があります。

さらに、モデル構造の調整方法は精度とパフォーマンスの考慮に基づいています。元のモデル構造を維持すると、**量子化精度が悪くなる**可能性や**推論パフォーマンスが悪化する**可能性があります。
